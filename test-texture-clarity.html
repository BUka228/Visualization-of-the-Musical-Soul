<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texture Clarity System Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
        }
        
        button {
            margin: 5px;
            padding: 8px 12px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        button:hover {
            background: #555;
        }
        
        button.active {
            background: #007acc;
        }
        
        #canvas {
            display: block;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>🎨 Texture Clarity System Test</h3>
        <p>Click on crystals to test focus transitions</p>
        <p>Use controls to test different clarity levels</p>
        <div id="status">Loading...</div>
    </div>
    
    <div id="controls">
        <h4>Texture Quality Controls</h4>
        <button id="lowQuality">Low Quality</button>
        <button id="mediumQuality" class="active">Medium Quality</button>
        <button id="highQuality">High Quality</button>
        <br>
        <button id="testTransition">Test Transition</button>
        <button id="resetCamera">Reset Camera</button>
    </div>
    
    <canvas id="canvas"></canvas>
    
    <script src="dist/bundle.js"></script>
    <script>
        // Test the texture clarity system
        async function initTextureClarityTest() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.textContent = 'Initializing Soul Galaxy system...';
                
                // Initialize the main application
                if (typeof window.initializeApp === 'function') {
                    await window.initializeApp();
                    statusDiv.textContent = 'Soul Galaxy system initialized ✅';
                } else {
                    throw new Error('Main application not available');
                }
                
                // Get references to the systems
                const sceneManager = window.sceneManager;
                const soulGalaxyRenderer = sceneManager?.getSoulGalaxyRenderer();
                
                if (!soulGalaxyRenderer) {
                    throw new Error('Soul Galaxy renderer not available');
                }
                
                const crystalTrackSystem = soulGalaxyRenderer.getCrystalTrackSystem();
                
                if (!crystalTrackSystem) {
                    throw new Error('Crystal Track System not available');
                }
                
                // Set up controls
                setupControls(crystalTrackSystem);
                
                statusDiv.textContent = 'Texture clarity test ready! Click crystals to test focus transitions.';
                
            } catch (error) {
                console.error('Failed to initialize texture clarity test:', error);
                statusDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        function setupControls(crystalTrackSystem) {
            const lowQualityBtn = document.getElementById('lowQuality');
            const mediumQualityBtn = document.getElementById('mediumQuality');
            const highQualityBtn = document.getElementById('highQuality');
            const testTransitionBtn = document.getElementById('testTransition');
            const resetCameraBtn = document.getElementById('resetCamera');
            
            // Get current crystal tracks
            const crystalTracks = crystalTrackSystem.getCrystalTracks();
            
            if (crystalTracks.length === 0) {
                console.warn('No crystal tracks available for testing');
                return;
            }
            
            // Test with the first crystal
            const testCrystal = crystalTracks[0];
            
            // Quality control buttons
            lowQualityBtn.addEventListener('click', async () => {
                setActiveButton(lowQualityBtn);
                console.log('🔽 Testing low quality texture...');
                
                const mesh = findCrystalMesh(crystalTrackSystem, testCrystal.id);
                if (mesh && mesh.material.setTextureClarity) {
                    mesh.material.setTextureClarity(0.2);
                    console.log('✅ Low quality texture applied');
                }
            });
            
            mediumQualityBtn.addEventListener('click', async () => {
                setActiveButton(mediumQualityBtn);
                console.log('🔄 Testing medium quality texture...');
                
                const mesh = findCrystalMesh(crystalTrackSystem, testCrystal.id);
                if (mesh && mesh.material.setTextureClarity) {
                    mesh.material.setTextureClarity(0.5);
                    console.log('✅ Medium quality texture applied');
                }
            });
            
            highQualityBtn.addEventListener('click', async () => {
                setActiveButton(highQualityBtn);
                console.log('🔼 Testing high quality texture...');
                
                const mesh = findCrystalMesh(crystalTrackSystem, testCrystal.id);
                if (mesh && mesh.material.setTextureClarity) {
                    mesh.material.setTextureClarity(1.0);
                    console.log('✅ High quality texture applied');
                }
            });
            
            // Test transition button
            testTransitionBtn.addEventListener('click', async () => {
                console.log('🎬 Testing focus transition...');
                
                try {
                    await crystalTrackSystem.focusOnCrystalWithAnimation(testCrystal);
                    console.log('✅ Focus transition completed');
                    
                    // Return after 3 seconds
                    setTimeout(async () => {
                        console.log('🔄 Returning camera...');
                        await crystalTrackSystem.returnCameraToPreviousPosition();
                        console.log('✅ Camera returned');
                    }, 3000);
                    
                } catch (error) {
                    console.error('❌ Focus transition failed:', error);
                }
            });
            
            // Reset camera button
            resetCameraBtn.addEventListener('click', async () => {
                console.log('🔄 Resetting camera...');
                
                try {
                    await crystalTrackSystem.returnCameraToPreviousPosition();
                    console.log('✅ Camera reset');
                } catch (error) {
                    console.error('❌ Camera reset failed:', error);
                }
            });
        }
        
        function setActiveButton(activeBtn) {
            const buttons = document.querySelectorAll('#controls button');
            buttons.forEach(btn => btn.classList.remove('active'));
            activeBtn.classList.add('active');
        }
        
        function findCrystalMesh(crystalTrackSystem, trackId) {
            const cluster = crystalTrackSystem.getCrystalCluster();
            if (!cluster) return null;
            
            return cluster.children.find(child => 
                child.userData && child.userData.trackId === trackId
            );
        }
        
        // Initialize when page loads
        window.addEventListener('load', initTextureClarityTest);
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.sceneManager && window.sceneManager.handleResize) {
                window.sceneManager.handleResize();
            }
        });
    </script>
</body>
</html>