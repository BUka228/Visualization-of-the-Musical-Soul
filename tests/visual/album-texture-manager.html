<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Album Texture Manager Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        #container {
            width: 100%;
            height: 600px;
            border: 1px solid #333;
            position: relative;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }
        #controls {
            margin-bottom: 20px;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #555;
        }
        .texture-preview {
            display: inline-block;
            margin: 5px;
            border: 1px solid #333;
        }
        .texture-preview canvas {
            width: 100px;
            height: 100px;
        }
        .texture-info {
            font-size: 10px;
            text-align: center;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>Album Texture Manager Test</h1>
    
    <div id="controls">
        <button onclick="testFallbackTextures()">Test Fallback Textures</button>
        <button onclick="testTextureLoading()">Test Texture Loading</button>
        <button onclick="testCacheStats()">Show Cache Stats</button>
        <button onclick="testMemoryUsage()">Test Memory Usage</button>
        <button onclick="clearCache()">Clear Cache</button>
    </div>

    <div id="container"></div>
    
    <div id="info">
        <div>Album Texture Manager Test</div>
        <div id="stats">Loading...</div>
    </div>

    <div id="texture-previews"></div>

    <script type="module">
        import * as THREE from 'three';
        import { AlbumTextureManager } from './src/soul-galaxy/materials/AlbumTextureManager.js';

        let scene, camera, renderer, textureManager;
        let testCubes = [];

        // Initialize Three.js scene
        function initScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            
            const container = document.getElementById('container');
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setClearColor(0x000011);
            container.appendChild(renderer.domElement);

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);

            camera.position.z = 10;

            // Initialize texture manager
            textureManager = new AlbumTextureManager({
                maxTextureSize: 256,
                cacheSize: 20,
                enableCompression: true,
                blurIntensity: 0.3,
                distortionStrength: 0.1
            });

            console.log('âœ… Scene and AlbumTextureManager initialized');
            updateStats();
        }

        // Test fallback textures for different genres
        window.testFallbackTextures = async function() {
            console.log('ðŸŽ¨ Testing fallback textures...');
            
            const genres = ['metal', 'rock', 'punk', 'electronic', 'jazz', 'classical', 'pop', 'indie', 'hiphop', 'unknown'];
            
            // Clear existing cubes
            testCubes.forEach(cube => scene.remove(cube));
            testCubes = [];

            const previewContainer = document.getElementById('texture-previews');
            previewContainer.innerHTML = '';

            for (let i = 0; i < genres.length; i++) {
                const genre = genres[i];
                
                // Get fallback texture
                const texture = textureManager.getFallbackTexture(genre);
                
                // Create cube with texture
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshLambertMaterial({ map: texture });
                const cube = new THREE.Mesh(geometry, material);
                
                // Position cubes in a grid
                const x = (i % 5) * 2.5 - 5;
                const y = Math.floor(i / 5) * 2.5 - 1;
                cube.position.set(x, y, 0);
                
                scene.add(cube);
                testCubes.push(cube);

                // Create preview canvas
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                // Draw texture to canvas for preview
                if (texture.image) {
                    ctx.drawImage(texture.image, 0, 0, 100, 100);
                }

                const previewDiv = document.createElement('div');
                previewDiv.className = 'texture-preview';
                previewDiv.innerHTML = `
                    <div class="texture-info">${genre}</div>
                `;
                previewDiv.appendChild(canvas);
                previewContainer.appendChild(previewDiv);
            }

            updateStats();
            console.log('âœ… Fallback textures created for all genres');
        };

        // Test texture loading with mock data
        window.testTextureLoading = async function() {
            console.log('ðŸ“¥ Testing texture loading...');
            
            // Create mock tracks with various scenarios
            const mockTracks = [
                {
                    id: 'track1',
                    name: 'Test Track 1',
                    artist: 'Test Artist',
                    album: 'Test Album',
                    genre: 'rock',
                    popularity: 80,
                    duration: 180,
                    color: '#0080FF',
                    size: 1.5,
                    position: new THREE.Vector3(0, 0, 0),
                    imageUrl: 'https://via.placeholder.com/300x300/0080FF/FFFFFF?text=Rock+Album'
                },
                {
                    id: 'track2',
                    name: 'Test Track 2',
                    artist: 'Test Artist 2',
                    album: 'Test Album 2',
                    genre: 'metal',
                    popularity: 90,
                    duration: 240,
                    color: '#FF0040',
                    size: 2.0,
                    position: new THREE.Vector3(0, 0, 0),
                    imageUrl: 'https://via.placeholder.com/300x300/FF0040/FFFFFF?text=Metal+Album'
                },
                {
                    id: 'track3',
                    name: 'Test Track 3',
                    artist: 'Test Artist 3',
                    album: 'Test Album 3',
                    genre: 'electronic',
                    popularity: 70,
                    duration: 200,
                    color: '#8000FF',
                    size: 1.8,
                    position: new THREE.Vector3(0, 0, 0),
                    imageUrl: 'https://invalid-url-that-will-fail.com/image.jpg' // This will fail and use fallback
                },
                {
                    id: 'track4',
                    name: 'Test Track 4',
                    artist: 'Test Artist 4',
                    album: 'Test Album 4',
                    genre: 'jazz',
                    popularity: 60,
                    duration: 220,
                    color: '#FFD700',
                    size: 1.3,
                    position: new THREE.Vector3(0, 0, 0)
                    // No imageUrl - will use fallback
                },
                {
                    id: 'track5',
                    name: 'Distortion Test',
                    artist: 'Memory Artist',
                    album: 'Blur Album',
                    genre: 'punk',
                    popularity: 85,
                    duration: 195,
                    color: '#00FF40',
                    size: 1.7,
                    position: new THREE.Vector3(0, 0, 0),
                    imageUrl: 'https://via.placeholder.com/300x300/00FF40/FFFFFF?text=Punk+Memory'
                }
            ];

            // Clear existing cubes
            testCubes.forEach(cube => scene.remove(cube));
            testCubes = [];

            try {
                // Preload textures
                await textureManager.preloadTextures(mockTracks);
                
                // Create cubes with loaded textures
                for (let i = 0; i < mockTracks.length; i++) {
                    const track = mockTracks[i];
                    const texture = await textureManager.getAlbumTexture(track);
                    
                    const geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
                    const material = new THREE.MeshLambertMaterial({ map: texture });
                    const cube = new THREE.Mesh(geometry, material);
                    
                    cube.position.set(i * 3 - 4.5, 0, 0);
                    scene.add(cube);
                    testCubes.push(cube);
                }
                
                updateStats();
                console.log('âœ… Texture loading test completed');
                
            } catch (error) {
                console.error('âŒ Error during texture loading test:', error);
            }
        };

        // Show cache statistics
        window.testCacheStats = function() {
            const stats = textureManager.getCacheStats();
            
            console.log('ðŸ“Š Cache Statistics:');
            console.log(`  Cached textures: ${stats.cachedTextures}`);
            console.log(`  Loading textures: ${stats.loadingTextures}`);
            console.log(`  Fallback textures: ${stats.fallbackTextures}`);
            console.log(`  Memory usage: ${(stats.memoryUsage / 1024 / 1024).toFixed(2)} MB`);
            
            alert(`Cache Stats:\nCached: ${stats.cachedTextures}\nLoading: ${stats.loadingTextures}\nFallback: ${stats.fallbackTextures}\nMemory: ${(stats.memoryUsage / 1024 / 1024).toFixed(2)} MB`);
        };

        // Test memory usage with many textures
        window.testMemoryUsage = async function() {
            console.log('ðŸ’¾ Testing memory usage...');
            
            const manyTracks = [];
            for (let i = 0; i < 50; i++) {
                manyTracks.push({
                    id: `track_${i}`,
                    name: `Track ${i}`,
                    artist: `Artist ${i}`,
                    album: `Album ${i}`,
                    genre: ['metal', 'rock', 'punk', 'electronic', 'jazz'][i % 5],
                    popularity: Math.random() * 100,
                    duration: 180 + Math.random() * 120,
                    color: '#FFFFFF',
                    size: 1.0,
                    position: new THREE.Vector3(0, 0, 0)
                });
            }
            
            const startStats = textureManager.getCacheStats();
            console.log(`Initial memory usage: ${(startStats.memoryUsage / 1024 / 1024).toFixed(2)} MB`);
            
            // Load all textures (will use fallbacks since no imageUrl)
            await textureManager.preloadTextures(manyTracks);
            
            const endStats = textureManager.getCacheStats();
            console.log(`Final memory usage: ${(endStats.memoryUsage / 1024 / 1024).toFixed(2)} MB`);
            console.log(`Memory increase: ${((endStats.memoryUsage - startStats.memoryUsage) / 1024 / 1024).toFixed(2)} MB`);
            
            updateStats();
        };

        // Clear cache
        window.clearCache = function() {
            console.log('ðŸ—‘ï¸ Clearing texture cache...');
            textureManager.dispose();
            
            // Recreate texture manager
            textureManager = new AlbumTextureManager({
                maxTextureSize: 256,
                cacheSize: 20,
                enableCompression: true,
                blurIntensity: 0.3,
                distortionStrength: 0.1
            });
            
            updateStats();
            console.log('âœ… Cache cleared and texture manager recreated');
        };

        // Update stats display
        function updateStats() {
            const stats = textureManager.getCacheStats();
            document.getElementById('stats').innerHTML = `
                Cached: ${stats.cachedTextures} | 
                Loading: ${stats.loadingTextures} | 
                Fallback: ${stats.fallbackTextures} | 
                Memory: ${(stats.memoryUsage / 1024 / 1024).toFixed(2)} MB
            `;
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Rotate test cubes
            testCubes.forEach((cube, index) => {
                cube.rotation.x += 0.01;
                cube.rotation.y += 0.01 * (1 + index * 0.1);
            });
            
            renderer.render(scene, camera);
        }

        // Handle window resize
        function onWindowResize() {
            const container = document.getElementById('container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        window.addEventListener('resize', onWindowResize);

        // Initialize everything
        initScene();
        animate();
        
        // Auto-run fallback texture test
        setTimeout(() => {
            testFallbackTextures();
        }, 1000);

    </script>
</body>
</html>