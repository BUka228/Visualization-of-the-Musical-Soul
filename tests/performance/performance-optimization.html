<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ - Music Galaxy 3D</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #performance-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            font-size: 12px;
            line-height: 1.4;
            z-index: 1000;
            max-width: 300px;
        }
        
        #performance-panel h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        
        .stat-label {
            color: #ccc;
        }
        
        .stat-value {
            color: #fff;
            font-weight: bold;
        }
        
        .warning {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 5px;
            border-radius: 3px;
            margin: 5px 0;
        }
        
        .optimization-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            z-index: 1000;
        }
        
        .optimization-controls h3 {
            margin: 0 0 10px 0;
            color: #2196F3;
        }
        
        .control-group {
            margin: 10px 0;
        }
        
        .control-group label {
            display: block;
            margin: 5px 0;
            cursor: pointer;
        }
        
        .control-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .control-group button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }
        
        .control-group button:hover {
            background: #45a049;
        }
        
        .fps-indicator {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
            z-index: 1000;
        }
        
        .fps-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .fps-good { color: #4CAF50; }
        .fps-medium { color: #FF9800; }
        .fps-bad { color: #f44336; }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <div id="performance-panel">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h3>
        <div class="stat-row">
            <span class="stat-label">FPS:</span>
            <span class="stat-value" id="fps-stat">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">–í—Ä–µ–º—è –∫–∞–¥—Ä–∞:</span>
            <span class="stat-value" id="frame-time-stat">0ms</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">–ü–∞–º—è—Ç—å:</span>
            <span class="stat-value" id="memory-stat">0MB</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Draw calls:</span>
            <span class="stat-value" id="draw-calls-stat">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏:</span>
            <span class="stat-value" id="triangles-stat">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">–í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤:</span>
            <span class="stat-value" id="total-objects-stat">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">–ò–Ω—Å—Ç–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö:</span>
            <span class="stat-value" id="instanced-objects-stat">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">–û—Ç—Å–µ—á–µ–Ω–Ω—ã—Ö:</span>
            <span class="stat-value" id="culled-objects-stat">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">–°–æ–∫—Ä–∞—â–µ–Ω–æ draw calls:</span>
            <span class="stat-value" id="reduced-calls-stat">0</span>
        </div>
        <div id="warnings-container"></div>
    </div>
    
    <div class="optimization-controls">
        <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π</h3>
        <div class="control-group">
            <label>
                <input type="checkbox" id="instanced-rendering" checked>
                –ò–Ω—Å—Ç–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
            </label>
            <label>
                <input type="checkbox" id="frustum-culling" checked>
                Frustum culling
            </label>
            <label>
                <input type="checkbox" id="resource-optimization" checked>
                –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
            </label>
            <label>
                <input type="checkbox" id="auto-optimization" checked>
                –ê–≤—Ç–æ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
            </label>
        </div>
        <div class="control-group">
            <button onclick="generateReport()">üìã –û—Ç—á–µ—Ç</button>
            <button onclick="forceOptimization()">üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</button>
            <button onclick="clearWarnings()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</button>
        </div>
        <div class="control-group">
            <button onclick="addMoreObjects()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã (—Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç)</button>
            <button onclick="resetScene()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å—Ü–µ–Ω—É</button>
        </div>
    </div>
    
    <div class="fps-indicator">
        <div>FPS</div>
        <div class="fps-value" id="fps-indicator">60</div>
    </div>

    <script type="module">
        import { SceneManager } from './dist/scene/SceneManager.js';
        import { DataProcessor } from './dist/data/DataProcessor.js';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let sceneManager;
        let performanceOptimizer;
        let dataProcessor;
        let currentTracks = [];

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ü–µ–Ω—ã
        const sceneConfig = {
            galaxyRadius: 50,
            objectMinSize: 0.5,
            objectMaxSize: 3.0,
            animationSpeed: 0.001,
            cameraDistance: 80,
            genreColors: {
                'metal': '#FF0000',
                'rock': '#FF4500',
                'indie': '#4169E1',
                'pop': '#FFD700',
                'electronic': '#9400D3',
                'jazz': '#228B22',
                'classical': '#F5F5DC',
                'hip-hop': '#8B4513',
                'default': '#FFFFFF'
            }
        };

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function generateTestTracks(count = 500) {
            const genres = ['metal', 'rock', 'indie', 'pop', 'electronic', 'jazz', 'classical', 'hip-hop'];
            const artists = ['Artist A', 'Artist B', 'Artist C', 'Artist D', 'Artist E'];
            const tracks = [];

            for (let i = 0; i < count; i++) {
                const genre = genres[Math.floor(Math.random() * genres.length)];
                const artist = artists[Math.floor(Math.random() * artists.length)];
                
                tracks.push({
                    id: `track_${i}`,
                    name: `Track ${i + 1}`,
                    artist: artist,
                    album: `Album ${Math.floor(i / 10) + 1}`,
                    genre: genre,
                    duration: 180 + Math.random() * 240, // 3-7 –º–∏–Ω—É—Ç
                    popularity: Math.random() * 100,
                    previewUrl: `https://example.com/preview_${i}.mp3`,
                    imageUrl: `https://example.com/cover_${i}.jpg`
                });
            }

            return tracks;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initializeApp() {
            try {
                console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...');

                // –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å—Ü–µ–Ω—ã
                const container = document.getElementById('container');
                sceneManager = new SceneManager(container, sceneConfig);
                sceneManager.initializeScene();

                // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                performanceOptimizer = sceneManager.getPerformanceOptimizer();

                // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
                dataProcessor = new DataProcessor(sceneConfig);

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const testTracks = generateTestTracks(500);
                currentTracks = dataProcessor.processTrackData(testTracks);

                // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Ç—Ä–µ–∫–æ–≤ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
                sceneManager.createTrackObjects(currentTracks);

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                setupPerformanceMonitoring();

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
                setupControls();

                console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                console.log(`üìä –°–æ–∑–¥–∞–Ω–æ ${currentTracks.length} —Ç—Ä–µ–∫–æ–≤ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π`);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function setupPerformanceMonitoring() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            setInterval(() => {
                if (performanceOptimizer) {
                    const stats = performanceOptimizer.getDetailedStats();
                    updatePerformanceUI(stats);
                }
            }, 1000);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ FPS –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä
            function updateFpsIndicator() {
                if (performanceOptimizer) {
                    const stats = performanceOptimizer.getStats();
                    const fpsElement = document.getElementById('fps-indicator');
                    const fps = Math.round(stats.currentFps);
                    
                    fpsElement.textContent = fps;
                    fpsElement.className = 'fps-value ' + 
                        (fps >= 50 ? 'fps-good' : fps >= 30 ? 'fps-medium' : 'fps-bad');
                }
                requestAnimationFrame(updateFpsIndicator);
            }
            updateFpsIndicator();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function updatePerformanceUI(detailedStats) {
            const { optimization, performance, culling, instancing } = detailedStats;

            // –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            document.getElementById('fps-stat').textContent = performance.fps;
            document.getElementById('frame-time-stat').textContent = performance.frameTime + 'ms';
            document.getElementById('memory-stat').textContent = performance.memoryUsage + 'MB';
            document.getElementById('draw-calls-stat').textContent = performance.drawCalls;
            document.getElementById('triangles-stat').textContent = performance.triangles;

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            document.getElementById('total-objects-stat').textContent = optimization.totalObjects;
            document.getElementById('instanced-objects-stat').textContent = optimization.instancedObjects;
            document.getElementById('culled-objects-stat').textContent = optimization.culledObjects;
            document.getElementById('reduced-calls-stat').textContent = optimization.drawCallsReduced;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
            updateWarningsUI();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        function updateWarningsUI() {
            const warningsContainer = document.getElementById('warnings-container');
            const monitor = performanceOptimizer.performanceMonitor;
            
            if (monitor) {
                const recentWarnings = monitor.getRecentWarnings(10000); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥
                
                warningsContainer.innerHTML = '';
                recentWarnings.forEach(warning => {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'warning';
                    warningDiv.textContent = `‚ö†Ô∏è ${warning.message}`;
                    warningsContainer.appendChild(warningDiv);
                });
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
        function setupControls() {
            // –ß–µ–∫–±–æ–∫—Å—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
            document.getElementById('instanced-rendering').addEventListener('change', (e) => {
                performanceOptimizer.updateConfig({ enableInstancedRendering: e.target.checked });
            });

            document.getElementById('frustum-culling').addEventListener('change', (e) => {
                performanceOptimizer.updateConfig({ enableFrustumCulling: e.target.checked });
            });

            document.getElementById('resource-optimization').addEventListener('change', (e) => {
                performanceOptimizer.updateConfig({ enableResourceOptimization: e.target.checked });
            });

            document.getElementById('auto-optimization').addEventListener('change', (e) => {
                performanceOptimizer.updateConfig({ autoOptimization: e.target.checked });
            });
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.generateReport = function() {
            if (performanceOptimizer) {
                const report = performanceOptimizer.generateReport();
                console.log(report);
                
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –æ—Ç—á–µ—Ç–æ–º
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); z-index: 2000; display: flex;
                    align-items: center; justify-content: center;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: #1a1a1a; color: white; padding: 20px;
                    border-radius: 8px; max-width: 80%; max-height: 80%;
                    overflow: auto; font-family: monospace; font-size: 12px;
                    white-space: pre-wrap;
                `;
                content.textContent = report;
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
                closeBtn.style.cssText = `
                    position: absolute; top: 10px; right: 10px;
                    background: #f44336; color: white; border: none;
                    padding: 5px 10px; border-radius: 4px; cursor: pointer;
                `;
                closeBtn.onclick = () => document.body.removeChild(modal);
                
                modal.appendChild(content);
                modal.appendChild(closeBtn);
                document.body.appendChild(modal);
            }
        };

        window.forceOptimization = function() {
            if (performanceOptimizer) {
                performanceOptimizer.forceUpdate();
                console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
            }
        };

        window.clearWarnings = function() {
            if (performanceOptimizer && performanceOptimizer.performanceMonitor) {
                performanceOptimizer.performanceMonitor.clearWarnings();
                updateWarningsUI();
                console.log('üóëÔ∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ—á–∏—â–µ–Ω—ã');
            }
        };

        window.addMoreObjects = function() {
            const additionalTracks = generateTestTracks(200);
            const processedTracks = dataProcessor.processTrackData(additionalTracks);
            currentTracks = [...currentTracks, ...processedTracks];
            
            sceneManager.createTrackObjects(currentTracks);
            console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ ${additionalTracks.length} –æ–±—ä–µ–∫—Ç–æ–≤. –í—Å–µ–≥–æ: ${currentTracks.length}`);
        };

        window.resetScene = function() {
            currentTracks = [];
            const testTracks = generateTestTracks(500);
            currentTracks = dataProcessor.processTrackData(testTracks);
            sceneManager.createTrackObjects(currentTracks);
            console.log('üîÑ –°—Ü–µ–Ω–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
        };

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        initializeApp();
    </script>
</body>
</html>