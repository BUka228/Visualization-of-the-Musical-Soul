<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç DataProcessor + DataLoader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #2d5a2d;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #5a2d2d;
            border-left: 4px solid #f44336;
        }
        .info {
            background: #2d3a5a;
            border-left: 4px solid #2196f3;
        }
        .genre-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            vertical-align: middle;
        }
        .track-item {
            margin: 5px 0;
            padding: 10px;
            background: #3a3a3a;
            border-radius: 4px;
            font-size: 14px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 6px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }
        .stat-label {
            font-size: 14px;
            color: #cccccc;
        }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #ffeb3b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç DataProcessor + DataLoader</h1>
        
        <div class="test-section">
            <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div id="test-results">
                <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤...</div>
            </div>
        </div>

        <div class="test-section">
            <h2>üéµ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏ (–ø–µ—Ä–≤—ã–µ 10)</h2>
            <div id="processed-tracks"></div>
        </div>

        <div class="test-section">
            <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∂–∞–Ω—Ä–æ–≤</h2>
            <div id="genre-stats"></div>
        </div>

        <div class="test-section">
            <h2>üîç –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div id="processing-stats"></div>
        </div>
    </div>

    <script type="module">
        import { DataProcessor } from './src/data/DataProcessor.js';
        import { DataLoader } from './src/data/DataLoader.js';
        import { Vector3 } from 'three';

        async function runIntegrationTests() {
            const resultsDiv = document.getElementById('test-results');
            const tracksDiv = document.getElementById('processed-tracks');
            const genreStatsDiv = document.getElementById('genre-stats');
            const processingStatsDiv = document.getElementById('processing-stats');
            
            resultsDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º loading
            
            const processor = new DataProcessor();
            let testsPassed = 0;
            let totalTests = 0;

            function addResult(message, success, details = '') {
                totalTests++;
                if (success) testsPassed++;
                
                const div = document.createElement('div');
                div.className = `test-result ${success ? 'success' : 'error'}`;
                div.innerHTML = `
                    <strong>${success ? '‚úÖ' : '‚ùå'} ${message}</strong>
                    ${details ? `<br><small>${details}</small>` : ''}
                `;
                resultsDiv.appendChild(div);
            }

            function addInfo(message) {
                const div = document.createElement('div');
                div.className = 'test-result info';
                div.innerHTML = `<strong>‚ÑπÔ∏è ${message}</strong>`;
                resultsDiv.appendChild(div);
            }

            try {
                addInfo('–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...');

                // –¢–µ—Å—Ç 1: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ DataLoader
                let musicData;
                try {
                    const loadResult = await DataLoader.loadMusicDataWithResult();
                    const success = loadResult.success && loadResult.data;
                    addResult('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ DataLoader', success, 
                        `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${loadResult.data?.tracks?.length || 0} —Ç—Ä–µ–∫–æ–≤, –î–µ–º–æ: ${loadResult.isDemo ? '–î–∞' : '–ù–µ—Ç'}`);
                    
                    if (success) {
                        musicData = loadResult.data;
                    } else {
                        throw new Error(loadResult.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                    }
                } catch (error) {
                    addResult('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ DataLoader', false, error.message);
                    return;
                }

                // –¢–µ—Å—Ç 2: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∏ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                let convertedTracks;
                try {
                    convertedTracks = processor.convertYandexTrackData(musicData.tracks);
                    const success = convertedTracks.length > 0;
                    addResult('–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∏', success, 
                        `–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${convertedTracks.length} –∏–∑ ${musicData.tracks.length} —Ç—Ä–µ–∫–æ–≤`);
                    
                    if (!success) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫–∏');
                    }
                } catch (error) {
                    addResult('–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∏', false, error.message);
                    return;
                }

                // –¢–µ—Å—Ç 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–µ–∫–æ–≤ –¥–ª—è 3D-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                let processedTracks;
                try {
                    processedTracks = processor.processTrackData(convertedTracks);
                    const success = processedTracks.length === convertedTracks.length;
                    addResult('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–µ–∫–æ–≤ –¥–ª—è 3D-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏', success, 
                        `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processedTracks.length} —Ç—Ä–µ–∫–æ–≤`);
                    
                    if (success) {
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
                        const displayTracks = processedTracks.slice(0, 10);
                        tracksDiv.innerHTML = displayTracks.map((track, index) => `
                            <div class="track-item">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <div class="genre-color" style="background-color: ${track.color}"></div>
                                    <strong>${track.name}</strong> - ${track.artist}
                                </div>
                                <div style="font-size: 12px; color: #cccccc;">
                                    –ñ–∞–Ω—Ä: ${track.genre} | –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å: ${track.popularity} | –†–∞–∑–º–µ—Ä: ${track.size} | 
                                    –ü–æ–∑–∏—Ü–∏—è: (${track.position.x.toFixed(1)}, ${track.position.y.toFixed(1)}, ${track.position.z.toFixed(1)})
                                </div>
                            </div>
                        `).join('');
                        
                        if (processedTracks.length > 10) {
                            tracksDiv.innerHTML += `<div class="info" style="text-align: center; margin-top: 10px;">... –∏ –µ—â–µ ${processedTracks.length - 10} —Ç—Ä–µ–∫–æ–≤</div>`;
                        }
                    }
                } catch (error) {
                    addResult('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–µ–∫–æ–≤ –¥–ª—è 3D-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏', false, error.message);
                    return;
                }

                // –¢–µ—Å—Ç 4: –ê–Ω–∞–ª–∏–∑ –∂–∞–Ω—Ä–æ–≤
                let genreStats;
                try {
                    genreStats = processor.analyzeGenres(convertedTracks);
                    const genreCount = Object.keys(genreStats).length;
                    const success = genreCount > 0;
                    addResult('–ê–Ω–∞–ª–∏–∑ –∂–∞–Ω—Ä–æ–≤', success, 
                        `–ù–∞–π–¥–µ–Ω–æ ${genreCount} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∂–∞–Ω—Ä–æ–≤`);
                    
                    if (success) {
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∂–∞–Ω—Ä–æ–≤
                        const sortedGenres = Object.entries(genreStats)
                            .sort(([,a], [,b]) => b.count - a.count);
                        
                        genreStatsDiv.innerHTML = sortedGenres.map(([genre, stats]) => `
                            <div class="track-item">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center;">
                                        <div class="genre-color" style="background-color: ${stats.color}"></div>
                                        <strong>${genre}</strong>
                                    </div>
                                    <div>
                                        ${stats.count} —Ç—Ä–µ–∫–æ–≤ (${stats.percentage}%)
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    addResult('–ê–Ω–∞–ª–∏–∑ –∂–∞–Ω—Ä–æ–≤', false, error.message);
                }

                // –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                try {
                    let validationErrors = [];
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ç—Ä–µ–∫–∏ –∏–º–µ—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
                    processedTracks.forEach((track, index) => {
                        if (!track.id) validationErrors.push(`–¢—Ä–µ–∫ ${index}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID`);
                        if (!track.name) validationErrors.push(`–¢—Ä–µ–∫ ${index}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ`);
                        if (!track.artist) validationErrors.push(`–¢—Ä–µ–∫ ${index}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å`);
                        if (!track.color || !track.color.startsWith('#')) validationErrors.push(`–¢—Ä–µ–∫ ${index}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ü–≤–µ—Ç`);
                        if (track.size < 0.5 || track.size > 3.0) validationErrors.push(`–¢—Ä–µ–∫ ${index}: —Ä–∞–∑–º–µ—Ä –≤–Ω–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞`);
                        if (!(track.position instanceof Vector3)) validationErrors.push(`–¢—Ä–µ–∫ ${index}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è`);
                        if (track.popularity < 0 || track.popularity > 100) validationErrors.push(`–¢—Ä–µ–∫ ${index}: –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 0-100`);
                    });
                    
                    const success = validationErrors.length === 0;
                    addResult('–í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö', success, 
                        success ? '–í—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã' : `–ù–∞–π–¥–µ–Ω–æ ${validationErrors.length} –æ—à–∏–±–æ–∫: ${validationErrors.slice(0, 3).join(', ')}${validationErrors.length > 3 ? '...' : ''}`);
                } catch (error) {
                    addResult('–í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö', false, error.message);
                }

                // –¢–µ—Å—Ç 6: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                try {
                    const stats = processor.getProcessingStats(processedTracks);
                    const success = stats.totalTracks === processedTracks.length;
                    addResult('–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏', success, 
                        `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è ${stats.totalTracks} —Ç—Ä–µ–∫–æ–≤`);
                    
                    if (success) {
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        processingStatsDiv.innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value">${stats.totalTracks}</div>
                                    <div class="stat-label">–í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${stats.averagePopularity}</div>
                                    <div class="stat-label">–°—Ä–µ–¥–Ω—è—è –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${stats.averageSize}</div>
                                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${stats.sizeRange.min} - ${stats.sizeRange.max}</div>
                                    <div class="stat-label">–î–∏–∞–ø–∞–∑–æ–Ω —Ä–∞–∑–º–µ—Ä–æ–≤</div>
                                </div>
                            </div>
                            <h4>–¢–æ–ø-5 –∂–∞–Ω—Ä–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É:</h4>
                            <pre>${JSON.stringify(
                                Object.entries(stats.genreDistribution)
                                    .sort(([,a], [,b]) => b - a)
                                    .slice(0, 5)
                                    .reduce((obj, [genre, count]) => ({ ...obj, [genre]: count }), {}),
                                null, 2
                            )}</pre>
                        `;
                    }
                } catch (error) {
                    addResult('–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏', false, error.message);
                }

                // –¢–µ—Å—Ç 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
                try {
                    const positions = processedTracks.map(track => track.position);
                    const distances = positions.map(pos => Math.sqrt(pos.x * pos.x + pos.y * pos.y + pos.z * pos.z));
                    const avgDistance = distances.reduce((sum, dist) => sum + dist, 0) / distances.length;
                    const minDistance = Math.min(...distances);
                    const maxDistance = Math.max(...distances);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ —Ä–∞–∑—É–º–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
                    const success = avgDistance > 20 && avgDistance < 80 && minDistance > 10 && maxDistance < 100;
                    addResult('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ñ–µ—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è', success, 
                        `–°—Ä–µ–¥–Ω—è—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è: ${avgDistance.toFixed(1)}, –î–∏–∞–ø–∞–∑–æ–Ω: ${minDistance.toFixed(1)} - ${maxDistance.toFixed(1)}`);
                } catch (error) {
                    addResult('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ñ–µ—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è', false, error.message);
                }

                // –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                addInfo(`–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${testsPassed}/${totalTests} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`);
                
                if (testsPassed === totalTests) {
                    addResult('–í—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ! üéâ', true, 
                        'DataProcessor –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å DataLoader –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ 3D-—Å—Ü–µ–Ω–µ');
                } else {
                    addResult(`–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã (${totalTests - testsPassed} –æ—à–∏–±–æ–∫)`, false, 
                        '–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏');
                }

            } catch (error) {
                addResult('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', false, error.message);
                console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', runIntegrationTests);
    </script>
</body>
</html>